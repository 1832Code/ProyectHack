name: Deploy Hackathon Services to Cloud Run

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'hackathon/**'
      - '.github/workflows/deploy-hackathon.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'hackathon/**'
      - '.github/workflows/deploy-hackathon.yml'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
  DEBUG: ${{ secrets.DEBUG || '' }}

jobs:
  deploy-company-lookup:
    name: Deploy Company Lookup API
    runs-on: ubuntu-latest
    
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Google Service Account JSON
        id: prepare-json
        run: |
          if echo "${{ secrets.GOOGLE_JSON }}" | base64 -d > /tmp/gcp-sa-key.json 2>/dev/null && [ -s /tmp/gcp-sa-key.json ]; then
            echo "Decoded from base64"
          else
            echo "${{ secrets.GOOGLE_JSON }}" > /tmp/gcp-sa-key.json
            echo "Used as plain JSON"
          fi
          CREDENTIALS=$(cat /tmp/gcp-sa-key.json)
          echo "::add-mask::$CREDENTIALS"
          {
            echo 'credentials_json<<EOF'
            echo "$CREDENTIALS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ steps.prepare-json.outputs.credentials_json }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Enable required APIs
        run: |
          gcloud services enable run.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true
          gcloud services enable cloudbuild.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true
          gcloud services enable artifactregistry.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true

      - name: Deploy Company Lookup Service
        working-directory: ./hackathon
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          DEBUG: ${{ secrets.DEBUG }}
        run: |
          echo "Deploying Company Lookup API to Cloud Run..."
          
          IMAGE_NAME="gcr.io/${{ env.GCP_PROJECT_ID }}/company-lookup-api"
          
          echo "Building Docker image..."
          gcloud builds submit \
            --tag "${IMAGE_NAME}" \
            --dockerfile Dockerfile.company \
            --project "${{ env.GCP_PROJECT_ID }}"
          
          ENV_VARS="APIFY_API_TOKEN=${APIFY_API_TOKEN}"
          
          if [ -n "${DEBUG}" ]; then
            ENV_VARS="${ENV_VARS},DEBUG=${DEBUG}"
          fi
          
          echo "Deploying to Cloud Run..."
          gcloud run deploy company-lookup-api \
            --image "${IMAGE_NAME}" \
            --region "${{ env.GCP_REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "${ENV_VARS}" \
            --memory 2Gi \
            --cpu 2 \
            --timeout 3600 \
            --max-instances 10 \
            --project "${{ env.GCP_PROJECT_ID }}"

      - name: Get service URL
        run: |
          SERVICE_URL=$(gcloud run services describe company-lookup-api \
            --region "${{ env.GCP_REGION }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --format 'value(status.url)')
          echo "✅ Company Lookup API deployed at: $SERVICE_URL"
          echo "::set-output name=url::$SERVICE_URL"

  deploy-google-search:
    name: Deploy Google Search API
    runs-on: ubuntu-latest
    
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Google Service Account JSON
        id: prepare-json
        run: |
          if echo "${{ secrets.GOOGLE_JSON }}" | base64 -d > /tmp/gcp-sa-key.json 2>/dev/null && [ -s /tmp/gcp-sa-key.json ]; then
            echo "Decoded from base64"
          else
            echo "${{ secrets.GOOGLE_JSON }}" > /tmp/gcp-sa-key.json
            echo "Used as plain JSON"
          fi
          CREDENTIALS=$(cat /tmp/gcp-sa-key.json)
          echo "::add-mask::$CREDENTIALS"
          {
            echo 'credentials_json<<EOF'
            echo "$CREDENTIALS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ steps.prepare-json.outputs.credentials_json }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Enable required APIs
        run: |
          gcloud services enable run.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true
          gcloud services enable cloudbuild.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true
          gcloud services enable artifactregistry.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true

      - name: Deploy Google Search Service
        working-directory: ./hackathon
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          DEBUG: ${{ secrets.DEBUG }}
        run: |
          echo "Deploying Google Search API to Cloud Run..."
          
          IMAGE_NAME="gcr.io/${{ env.GCP_PROJECT_ID }}/google-search-api"
          
          echo "Building Docker image..."
          gcloud builds submit \
            --tag "${IMAGE_NAME}" \
            --dockerfile Dockerfile.google \
            --project "${{ env.GCP_PROJECT_ID }}"
          
          ENV_VARS="APIFY_API_TOKEN=${APIFY_API_TOKEN}"
          
          if [ -n "${DEBUG}" ]; then
            ENV_VARS="${ENV_VARS},DEBUG=${DEBUG}"
          fi
          
          echo "Deploying to Cloud Run..."
          gcloud run deploy google-search-api \
            --image "${IMAGE_NAME}" \
            --region "${{ env.GCP_REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "${ENV_VARS}" \
            --memory 2Gi \
            --cpu 2 \
            --timeout 3600 \
            --max-instances 10 \
            --project "${{ env.GCP_PROJECT_ID }}"

      - name: Get service URL
        run: |
          SERVICE_URL=$(gcloud run services describe google-search-api \
            --region "${{ env.GCP_REGION }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --format 'value(status.url)')
          echo "✅ Google Search API deployed at: $SERVICE_URL"
          echo "::set-output name=url::$SERVICE_URL"

  deploy-instagram-search:
    name: Deploy Instagram Search API
    runs-on: ubuntu-latest
    
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Google Service Account JSON
        id: prepare-json
        run: |
          if echo "${{ secrets.GOOGLE_JSON }}" | base64 -d > /tmp/gcp-sa-key.json 2>/dev/null && [ -s /tmp/gcp-sa-key.json ]; then
            echo "Decoded from base64"
          else
            echo "${{ secrets.GOOGLE_JSON }}" > /tmp/gcp-sa-key.json
            echo "Used as plain JSON"
          fi
          CREDENTIALS=$(cat /tmp/gcp-sa-key.json)
          echo "::add-mask::$CREDENTIALS"
          {
            echo 'credentials_json<<EOF'
            echo "$CREDENTIALS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ steps.prepare-json.outputs.credentials_json }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Enable required APIs
        run: |
          gcloud services enable run.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true
          gcloud services enable cloudbuild.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true
          gcloud services enable artifactregistry.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true

      - name: Deploy Instagram Search Service
        working-directory: ./hackathon
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          DEBUG: ${{ secrets.DEBUG }}
        run: |
          echo "Deploying Instagram Search API to Cloud Run..."
          
          IMAGE_NAME="gcr.io/${{ env.GCP_PROJECT_ID }}/instagram-search-api"
          
          echo "Building Docker image..."
          gcloud builds submit \
            --tag "${IMAGE_NAME}" \
            --dockerfile Dockerfile.instagram \
            --project "${{ env.GCP_PROJECT_ID }}"
          
          ENV_VARS="APIFY_API_TOKEN=${APIFY_API_TOKEN}"
          
          if [ -n "${DEBUG}" ]; then
            ENV_VARS="${ENV_VARS},DEBUG=${DEBUG}"
          fi
          
          echo "Deploying to Cloud Run..."
          gcloud run deploy instagram-search-api \
            --image "${IMAGE_NAME}" \
            --region "${{ env.GCP_REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "${ENV_VARS}" \
            --memory 2Gi \
            --cpu 2 \
            --timeout 3600 \
            --max-instances 10 \
            --project "${{ env.GCP_PROJECT_ID }}"

      - name: Get service URL
        run: |
          SERVICE_URL=$(gcloud run services describe instagram-search-api \
            --region "${{ env.GCP_REGION }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --format 'value(status.url)')
          echo "✅ Instagram Search API deployed at: $SERVICE_URL"
          echo "::set-output name=url::$SERVICE_URL"

  validate:
    name: Validate deployment configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Dockerfile
        working-directory: ./hackathon
        run: |
          if [ ! -f Dockerfile ]; then
            echo "❌ Dockerfile not found"
            exit 1
          fi
          echo "✅ Dockerfile found"

      - name: Validate requirements.txt
        working-directory: ./hackathon
        run: |
          if [ ! -f requirements.txt ]; then
            echo "❌ requirements.txt not found"
            exit 1
          fi
          echo "✅ requirements.txt found"

      - name: Validate source code
        working-directory: ./hackathon
        run: |
          if [ ! -d src ]; then
            echo "❌ src directory not found"
            exit 1
          fi
          echo "✅ Source code structure valid"
      
      - name: Validate API files
        working-directory: ./hackathon
        run: |
          if [ ! -f src/api_company_lookup.py ]; then
            echo "❌ src/api_company_lookup.py not found"
            exit 1
          fi
          if [ ! -f src/api_google_search.py ]; then
            echo "❌ src/api_google_search.py not found"
            exit 1
          fi
          if [ ! -f src/api_instagram_search.py ]; then
            echo "❌ src/api_instagram_search.py not found"
            exit 1
          fi
          echo "✅ All API files found"
      
      - name: Validate Dockerfiles
        working-directory: ./hackathon
        run: |
          if [ ! -f Dockerfile.company ]; then
            echo "❌ Dockerfile.company not found"
            exit 1
          fi
          if [ ! -f Dockerfile.google ]; then
            echo "❌ Dockerfile.google not found"
            exit 1
          fi
          if [ ! -f Dockerfile.instagram ]; then
            echo "❌ Dockerfile.instagram not found"
            exit 1
          fi
          echo "✅ All Dockerfiles found"

